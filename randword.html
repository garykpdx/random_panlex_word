<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Random PanLex Expression</title>
    <script src="jquery-3.1.1.js"></script>
    <script>
        var API_URL = "http://api.panlex.org";
        var LV_ENG = 187;
        var english_word, results, lang, lang_name_eng;

        function query(path, params, cb) {
            $.post(API_URL + path, JSON.stringify(params), cb, "json");
        }

        function set_translation(word, lang_variety) {
            var params = { trtt: word, trlv: lang_variety, lv: LV_ENG,
                include: "trq", limit: 5, sort: "trq desc"};
            console.log("GET TRANS: " + JSON.stringify(params));

            query("/ex", params,
            function(response, status) {
                console.log("TRANSLATION RESULTS: " + JSON.stringify(response.result));

                if (response.resultNum > 0) {
                    var tr = response.result[0];

                    if (tr.trq > 10) {
                        english_word.html(tr.tt);
                    } else {
                        console.log("low quality: " + JSON.stringify(tr.trq));
                        // try with distance 2 translation
                        params.trdistance = 2;

                        query("/ex", params,
                        function(response, status) {
                            console.log("D2 TRANSLATION RESULTS: " + JSON.stringify(response.result));

                            if (response.resultNum > 0) {
                                tr = response.result[0];
                                if (tr.trq > 10) {
                                    english_word.html(tr.tt);
                                }
                            }
                        });
                    }
                } else {
                    // try with distance 2 translation
                    params = { trdistance: 2, trtt: word, trlv: lang_variety, lv: LV_ENG, include: "trq",
                                limit: 5, sort: "trq desc"};

                    query("/ex", params,
                    function(response, status) {
                        console.log("D2 TRANSLATION RESULTS: " + JSON.stringify(response.result));
                        if (response.resultNum > 0) {
                            if (response.result[0].trq > 10) {
                                document.getElementById("english_word").innerHTML = response.result[0].tt;
                            }
                        }
                    });
                }
            });
        }

        function fetch() {
            query("/lv", {sort: "random", limit: 1},
            function(data, status) {
                var lv = data.result[0];
                console.log(JSON.stringify(lv));

                query("/ex", { lv: lv.lv, limit: 1, sort: "random", include:"uid" },
                function(data2, status) {
                    var ex = data2.result[0];
                    console.log(JSON.stringify(data2));

                    english_word.html("");
                    results.html(ex.tt);
                    lang.html(lv.tt + " (" + lv.uid + ")");

                    var params = { "trtt": lv.tt, "include": "trq", "lv": LV_ENG,
                        "trlv":data.result[0].lv, "sort":"trq desc", "limit":1 };
                    console.log("PARAMS: " + JSON.stringify(params));

                    query("/ex", params,
                    function(data3, status) {
                        console.log("NAME TRANS: " + JSON.stringify(data3));
                        var eng_name = data3.resultNum > 0 ? data3.result[0].tt : "&nbsp;";
                        lang_name_eng.html(eng_name);
                    });

                    set_translation(ex.tt, lv.lv);
                });
            });
        }

        $(document).ready(function () {
            english_word = $("#english_word");
            results = $("#results");
            lang = $("#lang");
            lang_name_eng = $("#lang_name_eng");

            $("#fetch").click(fetch);
        });
    </script>
    <style>
        body {background:#d7d0b7;}
        h1 {color:black;text-align:center;}
        p {text-align:center;}
        p.intro {text-align:left;}
        div {text-align:left;}
        table {border-collapse: collapse;width:7in;margin-left:auto; margin-right:auto;}
        tr.values {background:#ccbbaa;border-bottom:1px solid #888;}
        tr.eng {background:#e7e0c7;}
        td {padding-right: 15px; padding-left: 10px;}
        td#results {width:100%;}
        td.label {font-weight:bold;}
        td.btn {text-align:center;padding-top:10px;padding-bottom:10px;width:50%;}
    </style>
</head>
<body>
<h1>Random PanLex Expression</h1>
<table><tr><td>
    <p class="intro">
        This is my unofficial PanLex random word selector.
        It chooses an expression at random from the PanLex database in a randomly chosen language.
    </p>
    <p class="intro">
        Note that some languages do not have any data added yet.
        If you want to see PanLex add data to your favorite language,
        and you know of some dictionary or other source, let them know so they can include it.
    </p>
</td></tr></table>
<br>

<div>
    <table>
        <tr class="values">
            <td class="label"><nobr>Random expression</nobr></td>
            <td id="results">&nbsp;</td>
        </tr>
        
        <tr class="eng" width="100%">
            <td class="label"><nobr>English translation</nobr></td>
            <td id="english_word">&nbsp;</td>
        </tr>
        
        <tr class="values">
            <td class="label"><nobr>Language variety name</nobr></td>
            <td id="lang">&nbsp;</td>
            
        </tr>
        <tr class="eng">
            <td class="label"><nobr>English name</nobr></td>
            <td id="lang_name_eng">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="2" class="btn">
                <button id="fetch">Fetch</button>
            </td>
        </tr>
    </table>
</div>
<p>Find out more about the project on the <a href="http://panlex.org" target="_blank">PanLex website</a>.</p>
</body>
</html>
