<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Random PanLex Expression</title>
    <script src="jquery-3.1.1.js"></script>
    <script>
        var API_URL = "http://api.panlex.org";
        var LV_ENG = 187;
        var LV_ISO_639_3 = 1622;
        var LV_ISO_PRINT_NAME = 1626;
        var english_word, results, lang_variety, lang_code, lang_name_eng;

        function query(path, params, cb) {
            $.post(API_URL + path, JSON.stringify(params), cb, "json");
        }

        function set_translation(word, lang_variety) {
            var params = { trtt: word, trlv: lang_variety, lv: LV_ENG,
                include: "trq", limit: 1, sort: "trq desc"};
            console.log("SET TRANSLATION: " + JSON.stringify(params));

            query("/ex", params,
            function(response, status) {
                console.log("D1 TRANSLATION RESULTS: " + JSON.stringify(response.result));

                if (response.resultNum > 0) {
                    var tr = response.result[0];

                    if (tr.trq > 10) {
                        english_word.html(tr.tt);
                    } else {
                        console.log("D1 low quality: " + JSON.stringify(tr.trq) + ", " + JSON.stringify(tr.tt));
                        getDistance2Translation(word, lang_variety);
                    }
                } else {
                    console.log("D1 no results: " + JSON.stringify(response.resultCount));
                    getDistance2Translation(word, lang_variety);
                }
            });
        }


        function getDistance2Translation(word, lang_variety) {
            params = {trdistance: 2, trtt:word, trlv:lang_variety, lv:LV_ENG, include:"trq", limit:1, sort:"trq desc"};
            query("/ex", params,
                function(response, status) {
                    console.log("D2 TRANSLATION RESULTS: " + JSON.stringify(response.result));
                    if (response.resultNum > 0) {
                        if (response.result[0].trq > 10) {
                            var tr = response.result[0];
                            english_word.html(tr.tt);
                        }
                    }
                });
        }
        
        
        function fetch() {
            lang_name_eng.html("");
            query("/lv", {sort: "random", limit: 1},
            function(lv_results, status) {
                var lv = lv_results.result[0];
                lang_code = lv_results.result[0].lc;
                console.log(JSON.stringify(lv));

                query("/ex", { lv: lv.lv, limit: 1, sort: "random", include:"uid" },
                function(lexeme_results, status) {
                    var ex = lexeme_results.result[0];
                    console.log(JSON.stringify(lexeme_results));

                    english_word.html("");
                    results.html(ex.tt);
                    lang.html(lv.tt + " (" + lv.uid + ")");

                    var params = { "trtt": lv.tt, "include": ["trq", "uid"], "lv": LV_ENG,
                                    "trlv":lv_results.result[0].lv, "sort":"trq desc", "limit":1 };
                    console.log("PARAMS: " + JSON.stringify(params));

                    query("/ex", params, get_eng_lang_name);
                    set_translation(ex.tt, lv.lv);
                });
            });
        }



        function get_eng_lang_name(eng_name_results, status) {
            console.log("NAME TRANS: " + JSON.stringify(eng_name_results));
            var eng_name;

            if (eng_name_results.resultNum > 0) {
                eng_name = eng_name_results.result[0].tt;
                console.log("ENG LV NAME FOUND: " + JSON.stringify(eng_name_results));
            }
            else {
                // TODO: get source LV name to translate into art-290 (art-001 ?)
                console.log("ENG NAME NOT FOUND: " + JSON.stringify(eng_name_results));
                var params = { "trtt":lang_code, "trlv": LV_ISO_639_3, "include": "trq", 
                                "lv": LV_ISO_PRINT_NAME, "sort":"trq desc", "limit":1 };
                console.log("GET ISO NAME: " + JSON.stringify(params));
                query("/ex", params, get_iso_print_name);
            }

            lang_name_eng.html(eng_name);
        }


        function get_iso_print_name(iso_print_name, status) {
            console.log("ISO NAME: " + iso_print_name.result[0].tt);
            lang_name_eng.html("variety of " + iso_print_name.result[0].tt);
        }


        $(document).ready(function () {
            english_word = $("#english_word");
            results = $("#results");
            lang = $("#lang");
            lang_name_eng = $("#lang_name_eng");

            $("#fetch").click(fetch);
        });
    </script>
    <style>
        body {background:#d7d0b7;}
        h1 {color:black;text-align:center;}
        p {text-align:center;}
        p.intro {text-align:left;}
        div {text-align:left;}
        table {border-collapse: collapse;width:7in;margin-left:auto; margin-right:auto;}
        tr.values {background:#ccbbaa;border-bottom:1px solid #888;}
        tr.eng {background:#e7e0c7;}
        td {padding-right: 15px; padding-left: 10px;}
        td#results {width:100%;}
        td.label {font-weight:bold;}
        td.btn {text-align:center;padding-top:10px;padding-bottom:10px;width:50%;}
    </style>
</head>
<body>
<h1>Random PanLex Expression</h1>
<table><tr><td>
    <p class="intro">
        This is my unofficial PanLex random word selector.
        It chooses an expression at random from the PanLex database in a randomly chosen language.
    </p>
    <p class="intro">
        Note that some languages do not have any data added yet.
        If you want to see PanLex add data to your favorite language,
        and you know of some dictionary or other source, let them know so they can include it.
    </p>
</td></tr></table>
<br>

<div>
    <table>
        <tr class="values">
            <td class="label"><nobr>Random expression</nobr></td>
            <td id="results">&nbsp;</td>
        </tr>
        
        <tr class="eng" width="100%">
            <td class="label"><nobr>English translation</nobr></td>
            <td id="english_word">&nbsp;</td>
        </tr>
        
        <tr class="values">
            <td class="label"><nobr>Language variety name</nobr></td>
            <td id="lang">&nbsp;</td>
            
        </tr>
        <tr class="eng">
            <td class="label"><nobr>English name</nobr></td>
            <td id="lang_name_eng">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="2" class="btn">
                <button id="fetch">Fetch</button>
            </td>
        </tr>
    </table>
</div>
<p>Find out more about the project on the <a href="http://panlex.org" target="_blank">PanLex website</a>.</p>
</body>
</html>
